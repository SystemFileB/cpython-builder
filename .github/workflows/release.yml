name: å‘å¸ƒåˆ° Releases

on:
  workflow_run:
    workflows: 
      - "æ„å»º - Osä¼˜åŒ– - åŠ¨æ€é“¾æ¥"
      - "æ„å»º - Osä¼˜åŒ– - é™æ€é“¾æ¥"
      - "æ„å»º - O2ä¼˜åŒ– - åŠ¨æ€é“¾æ¥" 
      - "æ„å»º - O2ä¼˜åŒ– - é™æ€é“¾æ¥"
      - "æ„å»º - O3ä¼˜åŒ– - åŠ¨æ€é“¾æ¥"
      - "æ„å»º - O3ä¼˜åŒ– - é™æ€é“¾æ¥"
    types: [completed]
    branches: [main]  # æ·»åŠ è¿™è¡Œç¡®ä¿åªåœ¨ä¸»åˆ†æ”¯è§¦å‘

jobs:
  release:
    # ä¿®æ”¹æ¡ä»¶åˆ¤æ–­ï¼Œç¡®ä¿æ‰€æœ‰å·¥ä½œæµéƒ½æˆåŠŸ
    if: |
      contains(fromJson('["æ„å»º - Osä¼˜åŒ– - åŠ¨æ€é“¾æ¥", "æ„å»º - Osä¼˜åŒ– - é™æ€é“¾æ¥", "æ„å»º - O2ä¼˜åŒ– - åŠ¨æ€é“¾æ¥", "æ„å»º - O2ä¼˜åŒ– - é™æ€é“¾æ¥", "æ„å»º - O3ä¼˜åŒ– - åŠ¨æ€é“¾æ¥", "æ„å»º - O3ä¼˜åŒ– - é™æ€é“¾æ¥"]'), github.event.workflow_run.name) &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: windows-latest
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          path: artifacts

      - name: é‡å‘½åå¹¶æ‰“åŒ…
        shell: powershell
        run: |
          $date = Get-Date -Format "yyMMdd"
          Get-ChildItem artifacts -Recurse -Filter *.tar.xz | ForEach-Object {
              $parent = $_.Directory.Name
              $optimize = if ($parent.Contains('Os')) { 'Os' } 
                        elseif ($parent.Contains('O2')) { 'O2' }
                        else { 'O3' }
              $linkType = if ($parent.Contains('static')) { 'static' } else { 'dynamic' }
              $arch = $parent.Split('-')[-1]
              $newName = "python-${date}-$arch-$optimize-$linkType.tar.xz"
              Move-Item $_.FullName "artifacts/$newName"
          }

      - name: è·å–æ—¥æœŸä¾› Release ä½¿ç”¨
        id: get-date
        run: echo "current-date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        shell: bash

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: $(date -u +'%Y%m%d')
          name: "python-builder Build Time: ($(date -u +'%Y-%m-%d')) Release"
          body: |
            ## ğŸš€ Pythonçš„MinGWè‡ªåŠ¨æ„å»ºå‘å¸ƒ
            æ„å»ºæ—¶é—´ï¼š${{ steps.get-date.outputs.current-date }}

            è¿™ä¸ªç‰ˆæœ¬æœ€ä½æ”¯æŒçš„Windowsç‰ˆæœ¬ä¸ºWindows 8ï¼Œä½†æ˜¯ä½ å¯ä»¥è¯•è¯•æŠŠå®ƒæ”¾åœ¨Windows 7ä¸Šè¿è¡Œ

            ## ğŸ¤” æˆ‘è¦ä¸‹è½½å“ªä¸ªï¼Ÿ
            æ–‡ä»¶åçš„æ ¼å¼ä¸ºï¼š`python-<æ—¥æœŸ>-<æ¶æ„>-<ä¼˜åŒ–çº§åˆ«>-<é“¾æ¥ç±»å‹>.tar.xz`

            å¦‚æœçœŸçš„ä¸çŸ¥é“æ€ä¹ˆé€‰ï¼Œè¯·é€‰æ‹©`python-<æ—¥æœŸ>-x86_64-O2-dynamic.tar.xz`

            å¦‚æœä½ å€¾å‘é€Ÿåº¦ï¼Œå¯ä»¥é€‰æ‹©`python-<æ—¥æœŸ>-x86_64-O3-dynamic.tar.xz`  
            å¦‚æœä½ å€¾å‘å¤§å°ï¼Œå¯ä»¥é€‰æ‹©`python-<æ—¥æœŸ>-x86_64-Os-dynamic.tar.xz`  
          prerelease: false
          files: |
            artifacts/python-*.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
